name: Advanced Testing Suite

on:
  schedule:
    - cron: '0 3 * * 0'  # Weekly on Sunday at 3 AM UTC
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'tests/**'
      - 'src/**'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"

jobs:
  property-based-tests:
    name: Property-Based Testing (Hypothesis)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest hypothesis pytest-timeout
      
      - name: Run property-based tests
        run: |
          pytest tests/ -v -m property --timeout=300 || echo "Property tests completed"
        continue-on-error: true
      
      - name: Generate report
        run: |
          echo "## Property-Based Testing" >> $GITHUB_STEP_SUMMARY
          echo "Uses Hypothesis for generative testing" >> $GITHUB_STEP_SUMMARY

  stress-tests:
    name: Stress & Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-benchmark pytest-timeout memory_profiler
      
      - name: Run stress tests
        run: |
          pytest tests/ -v -m stress --timeout=600 || echo "Stress tests completed"
        continue-on-error: true
      
      - name: Run performance benchmarks
        run: |
          pytest tests/ -v -m performance --benchmark-only --benchmark-autosave || echo "Benchmarks completed"
        continue-on-error: true
      
      - name: Memory profiling
        run: |
          python -m memory_profiler tests/test_performance.py || true
        continue-on-error: true

  regression-tests:
    name: Regression Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for regression
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-regressions
      
      - name: Run regression tests
        run: |
          pytest tests/ -v -m regression || echo "Regression tests completed"
        continue-on-error: true

  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install mutmut pytest
      
      - name: Run mutation testing
        run: |
          mutmut run --paths-to-mutate=src/ || echo "Mutation testing completed"
          mutmut results || true
          mutmut html || true
        continue-on-error: true
      
      - name: Upload mutation report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: mutation-report
          path: html/
        continue-on-error: true

  coverage-analysis:
    name: Deep Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov coverage[toml]
      
      - name: Run tests with detailed coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-branch \
            || echo "Coverage analysis completed"
        continue-on-error: true
      
      - name: Generate coverage badge
        run: |
          coverage report --precision=2
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY || true
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
        continue-on-error: true

  success:
    name: Advanced Testing Complete
    needs: [property-based-tests, stress-tests, regression-tests, mutation-testing, coverage-analysis]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Generate summary
        run: |
          echo "## Advanced Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Property-Based | ${{ needs.property-based-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stress Tests | ${{ needs.stress-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regression | ${{ needs.regression-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mutation | ${{ needs.mutation-testing.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Advanced testing suite completed" >> $GITHUB_STEP_SUMMARY
