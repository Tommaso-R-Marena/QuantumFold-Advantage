name: Test Notebook Execution

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    paths:
      - 'examples/*.ipynb'
      - 'src/**'
      - 'tests/test_notebook_execution.py'
      - '.github/workflows/test-notebooks-execution.yml'
  workflow_dispatch:

jobs:
  test-notebooks:
    name: Execute Notebooks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    
    strategy:
      fail-fast: false
      matrix:
        notebook:
          - colab_quickstart.ipynb
          - 01_getting_started.ipynb
          - 02_quantum_vs_classical.ipynb
          - 03_advanced_visualization.ipynb
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Cache pip packages
      uses: actions/cache@v5
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-notebooks-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-notebooks-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # NumPy 2.0 fix
        pip uninstall -y numpy jax jaxlib autograd pennylane 2>/dev/null || true
        pip install --force-reinstall --no-deps 'numpy>=1.23.0,<2.0.0'
        pip install --no-deps 'autograd>=1.6.2'
        pip install --no-deps 'pennylane>=0.32.0'
        
        # Install package with test dependencies
        pip install -e .[dev,protein-lm]
        
        # Install notebook execution tools
        pip install nbconvert nbformat jupyter ipykernel
    
    - name: Verify NumPy version
      run: |
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        python -c "import numpy; assert numpy.__version__ < '2.0', 'NumPy 2.0+ detected!'"
    
    - name: Execute notebook
      run: |
        echo "Testing ${{ matrix.notebook }}..."
        jupyter nbconvert --to notebook --execute \
          --ExecutePreprocessor.timeout=600 \
          --ExecutePreprocessor.kernel_name=python3 \
          --output-dir=/tmp/executed \
          examples/${{ matrix.notebook }}
        
        echo "Notebook executed successfully!"
    
    - name: Validate outputs
      run: |
        python -c "
        import nbformat
        import sys
        
        nb_path = '/tmp/executed/${{ matrix.notebook }}'
        with open(nb_path, 'r') as f:
            nb = nbformat.read(f, as_version=4)
        
        # Count cells with outputs
        code_cells = sum(1 for c in nb.cells if c.cell_type == 'code')
        cells_with_output = sum(1 for c in nb.cells if c.cell_type == 'code' and c.outputs)
        errors = sum(1 for c in nb.cells if c.cell_type == 'code' and any(o.output_type == 'error' for o in c.outputs))
        
        print(f'Code cells: {code_cells}')
        print(f'Cells with output: {cells_with_output}')
        print(f'Cells with errors: {errors}')
        
        if errors > 0:
            print('Notebook has errors!')
            sys.exit(1)
        
        if cells_with_output == 0:
            print('No outputs generated!')
            sys.exit(1)
        
        print('Notebook validation passed!')
        "
    
    - name: Upload executed notebook
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: executed-${{ matrix.notebook }}
        path: /tmp/executed/${{ matrix.notebook }}
        retention-days: 7
  
  test-notebook-structure:
    name: Test Notebook Structure
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pytest nbformat
    
    - name: Run structure tests
      run: |
        pytest tests/test_notebook_execution.py::TestNotebookStructure -v
    
    - name: Run content tests
      run: |
        pytest tests/test_notebook_execution.py::TestNotebookContent -v
  
  summary:
    name: Test Summary
    if: always()
    needs: [test-notebooks, test-notebook-structure]
    runs-on: ubuntu-latest
    
    steps:
    - name: Check test results
      run: |
        echo "## Notebook Execution Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test-notebooks.result }}" == "success" ]]; then
          echo "All notebooks executed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Notebooks" >> $GITHUB_STEP_SUMMARY
          echo "- colab_quickstart.ipynb" >> $GITHUB_STEP_SUMMARY
          echo "- 01_getting_started.ipynb" >> $GITHUB_STEP_SUMMARY
          echo "- 02_quantum_vs_classical.ipynb" >> $GITHUB_STEP_SUMMARY
          echo "- 03_advanced_visualization.ipynb" >> $GITHUB_STEP_SUMMARY
        else
          echo "Some notebooks failed execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test-notebook-structure.result }}" == "success" ]]; then
          echo "Notebook structure tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "Notebook structure tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Executed notebooks are available as workflow artifacts for 7 days." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### NumPy Fix Applied" >> $GITHUB_STEP_SUMMARY
        echo "All notebooks executed with NumPy <2.0 to prevent compatibility issues." >> $GITHUB_STEP_SUMMARY