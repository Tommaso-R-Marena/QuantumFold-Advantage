name: Status Checks

# Aggregate workflow that runs all required checks
on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Meta job that waits for all required checks
  all-checks-complete:
    name: All Checks Complete
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-ci, validate-cd, code-quality-gate]
    
    steps:
      - name: Report Success
        run: |
          echo "## âœ… All Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required CI/CD checks have completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CI Validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CD Validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality Gates" >> $GITHUB_STEP_SUMMARY
  
  validate-ci:
    name: Validate CI Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate workflow files
        run: |
          echo "ðŸ” Validating GitHub Actions workflows..."
          
          # Check all workflow files exist
          REQUIRED_WORKFLOWS=(
            ".github/workflows/ci.yml"
            ".github/workflows/ci-comprehensive.yml"
            ".github/workflows/docker-publish.yml"
            ".github/workflows/test-report.yml"
            ".github/workflows/release.yml"
          )
          
          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            if [ -f "$workflow" ]; then
              echo "âœ… Found: $workflow"
            else
              echo "âŒ Missing: $workflow"
              exit 1
            fi
          done
          
          echo ""
          echo "âœ… All required workflows present"
      
      - name: Check workflow syntax
        run: |
          echo "ðŸ” Checking YAML syntax..."
          
          # Install yamllint if needed
          pip install yamllint
          
          # Check all workflow files
          yamllint -f parsable .github/workflows/ || echo "YAML warnings present"
          
          echo "âœ… Workflow syntax valid"
  
  validate-cd:
    name: Validate CD Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Dockerfile
        run: |
          echo "ðŸ³ Checking Dockerfile..."
          
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile exists"
            
            # Basic validation
            if grep -q "FROM" Dockerfile && grep -q "WORKDIR" Dockerfile; then
              echo "âœ… Dockerfile has required directives"
            else
              echo "âš ï¸  Dockerfile may be incomplete"
            fi
          else
            echo "âŒ Dockerfile not found"
            exit 1
          fi
      
      - name: Check release configuration
        run: |
          echo "ðŸ“¦ Checking release configuration..."
          
          if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            echo "âœ… Python package configuration found"
          else
            echo "âš ï¸  No setup.py or pyproject.toml found"
          fi
          
          if [ -f ".github/workflows/release.yml" ]; then
            echo "âœ… Release workflow configured"
          else
            echo "âŒ Release workflow missing"
            exit 1
          fi
  
  code-quality-gate:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install quality tools
        run: |
          pip install --upgrade pip
          pip install black isort flake8 pylint bandit safety
      
      - name: Check code formatting
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          black --check src tests || {
            echo "âš ï¸  Code needs formatting - run: black src tests"
            echo "formatting_needed=true" >> $GITHUB_ENV
          }
        continue-on-error: true
      
      - name: Check import sorting
        run: |
          echo "ðŸ“š Checking import sorting..."
          isort --check-only src tests || {
            echo "âš ï¸  Imports need sorting - run: isort src tests"
            echo "imports_unsorted=true" >> $GITHUB_ENV
          }
        continue-on-error: true
      
      - name: Lint check
        run: |
          echo "ðŸ” Running linter..."
          flake8 src tests --count --statistics || {
            echo "âš ï¸  Linting issues found"
            echo "lint_issues=true" >> $GITHUB_ENV
          }
        continue-on-error: true
      
      - name: Security scan
        run: |
          echo "ðŸ”’ Running security scan..."
          bandit -r src -ll || {
            echo "âš ï¸  Security issues found"
            echo "security_issues=true" >> $GITHUB_ENV
          }
        continue-on-error: true
      
      - name: Quality summary
        run: |
          echo "## ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$formatting_needed" = "true" ]; then
            echo "- âš ï¸  Formatting: Needs attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Formatting: Good" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$imports_unsorted" = "true" ]; then
            echo "- âš ï¸  Imports: Needs sorting" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Imports: Well organized" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$lint_issues" = "true" ]; then
            echo "- âš ï¸  Linting: Issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Linting: Clean" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$security_issues" = "true" ]; then
            echo "- âš ï¸  Security: Issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Security: No issues" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Note: These are informational. Code quality checks won't block PRs but should be addressed.*" >> $GITHUB_STEP_SUMMARY
