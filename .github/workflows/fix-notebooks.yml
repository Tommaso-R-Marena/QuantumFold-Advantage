name: Fix Notebook JSON Formatting

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'examples/**/*.ipynb'
      - 'notebooks/**/*.ipynb'
  workflow_dispatch:

permissions:
  contents: write

# Prevent concurrent notebook fixes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fix-notebooks:
    name: Fix Notebook Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      
      - name: Fix notebook formatting
        id: fix_notebooks
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path
          
          def fix_multiline_fstrings_in_cell(source_lines):
              """Fix multi-line f-strings in a single cell."""
              fixed = []
              i = 0
              while i < len(source_lines):
                  line = source_lines[i]
                  # Check for f-string continuation pattern
                  if i < len(source_lines) - 1:
                      curr = line.rstrip()
                      next_line = source_lines[i + 1]
                      next_stripped = next_line.lstrip()
                      
                      # If current line ends with quote and next starts with f'
                      if (curr.endswith("'") or curr.endswith('"')):
                          if next_stripped.startswith("f'") or next_stripped.startswith('f"'):
                              # Merge them
                              merged = curr[:-1] + " " + next_stripped[2:]
                              # Keep original indentation
                              indent = len(line) - len(line.lstrip())
                              fixed.append(" " * indent + merged.lstrip() + "\n")
                              i += 2
                              continue
                  
                  fixed.append(line)
                  i += 1
              return fixed
          
          def fix_notebook(path):
              """Fix a notebook file."""
              print(f"Checking {path}...")
              try:
                  with open(path, 'r', encoding='utf-8') as f:
                      nb = json.load(f)
              except Exception as e:
                  print(f"  ⚠️  Skipping {path}: {e}")
                  return False
              
              modified = False
              cells_fixed = 0
              
              for cell in nb.get('cells', []):
                  if cell.get('cell_type') == 'code' and 'source' in cell:
                      original = cell['source']
                      fixed = fix_multiline_fstrings_in_cell(original)
                      if fixed != original:
                          cell['source'] = fixed
                          modified = True
                          cells_fixed += 1
              
              if modified:
                  try:
                      with open(path, 'w', encoding='utf-8') as f:
                          json.dump(nb, f, indent=1, ensure_ascii=False)
                          f.write('\n')  # trailing newline
                      print(f"  ✅ Fixed {cells_fixed} cell(s) in {path}")
                      return True
                  except Exception as e:
                      print(f"  ❌ Error writing {path}: {e}")
                      return False
              else:
                  print(f"  ℹ️  No changes needed for {path}")
              return False
          
          # Find and fix all notebooks
          notebook_dirs = ['examples', 'notebooks']
          notebooks = []
          for nb_dir in notebook_dirs:
              nb_path = Path(nb_dir)
              if nb_path.exists():
                  notebooks.extend(nb_path.glob('**/*.ipynb'))
          
          if not notebooks:
              print("No notebooks found")
              sys.exit(0)
          
          print(f"\nFound {len(notebooks)} notebook(s) to check\n")
          
          any_fixed = False
          for nb_path in notebooks:
              if fix_notebook(nb_path):
                  any_fixed = True
          
          if any_fixed:
              print("\n✅ Some notebooks were fixed")
          else:
              print("\nℹ️  All notebooks are already correctly formatted")
          
          sys.exit(0)  # Always succeed
          EOF
      
      - name: Check for changes
        id: verify_changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            git diff --stat
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push fixes
        if: steps.verify_changes.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          # Add files using find to avoid glob issues
          find examples notebooks -name '*.ipynb' -type f 2>/dev/null | xargs git add || true
          if git diff --staged --quiet; then
            echo "No staged changes to commit"
            exit 0
          fi
          git commit -m "fix: Auto-fix multi-line f-strings in notebooks [skip ci]"
          git push
      
      - name: Summary
        if: always()
        run: |
          echo "## Notebook Formatting" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ steps.verify_changes.outputs.changed == 'true' && '✅ Fixed' || 'ℹ️ No changes needed' }}" >> $GITHUB_STEP_SUMMARY
