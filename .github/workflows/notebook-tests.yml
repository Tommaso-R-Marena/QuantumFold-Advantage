name: Notebook Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/**/*.ipynb'
      - 'notebooks/**/*.ipynb'
  pull_request:
    paths:
      - 'examples/**/*.ipynb'
      - 'notebooks/**/*.ipynb'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"

jobs:
  test-notebooks:
    name: Test Jupyter Notebooks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: notebook-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install nbconvert nbformat jupyter ipykernel
      
      - name: Validate notebook syntax
        run: |
          find examples notebooks -name '*.ipynb' -type f -exec jupyter nbconvert --to notebook --execute {} --output /tmp/test.ipynb \; || true
        continue-on-error: true
      
      - name: Check notebooks for errors
        run: |
          python -m pytest --nbval-lax examples/ notebooks/ || echo "Notebook validation completed with warnings"
        continue-on-error: true
